"""
 * Scenario 09: Security Vulnerability Detection
 * ===============================
 * Use GitHub Copilot to scan for security vulnerabilities in code.
 *
 * INSTRUCTIONS:
 * 1. Review each exercise and identify the security vulnerability
 * 2. Use Copilot Chat: "Perform a security check" or "Check for vulnerabilities"
 * 3. Ask Copilot to explain the vulnerability and suggest fixes
 * 4. Request secure code examples
 *
 * COMMON VULNERABILITIES DEMONSTRATED:
 * - Hardcoded API keys (Exercise 1)
 * - SQL Injection (Exercise 2)
 * - Path Traversal (Exercise 3)
 """
 
# =============================================================================
# EXERCISE 1: Hardcoded API Key
# =============================================================================
# TODO: Ask Copilot Chat: "What security issues do you see in this code?"

import requests
import json


# Sample API endpoint
url = "https://api.example.com/weather"

# Sample payload
payload = {
    "project": "sample_project",
    "version": "1.0.0"
}

headers = {
    "Content-Type": "application/json",
    "API-Key": "sk_live_51HxYz2KI3pQrs..."  # ⚠️ NEVER do this!
}

# Make a POST request to the API
response = requests.post(url, data=json.dumps(payload), headers=headers)

# Check if the request was successful
if response.status_code == 200:
    print("Weather data retrieved successfully.")
    # Parse the JSON response


# =============================================================================
# EXERCISE 2: Database query with potential SQL injection
# =============================================================================
# TODO: Ask Copilot Chat: "Perform a security check on this function"

import sqlite3

def get_user_by_username(username):
    """Fetch user data from database by username."""
    conn = sqlite3.connect('users.db')
    cursor = conn.cursor()
    
    query = f"SELECT * FROM users WHERE username = '{username}'"
    cursor.execute(query)
    
    result = cursor.fetchone()
    conn.close()
    return result

# Example usage
# user = get_user_by_username("admin' OR '1'='1")  # This could expose all users!


# =============================================================================
# EXERCISE 3: Insecure file path handling
# =============================================================================
# TODO: Ask Copilot Chat: "Check this code for security vulnerabilities"

import os

def read_user_file(filename):
    """Read a file from the user uploads directory."""
    base_dir = "/var/www/uploads/"
    
    # VULNERABILITY: Path traversal - no validation of filename
    # An attacker could use "../../../etc/passwd" to read sensitive files
    file_path = base_dir + filename
    
    with open(file_path, 'r') as f:
        content = f.read()
    
    return content

# Example usage
# data = read_user_file("../../../etc/passwd")  # Path traversal attack!


# =============================================================================
# KEY TAKEAWAYS
# =============================================================================
"""
 * ✅ Use Copilot Chat to identify security vulnerabilities
 * ✅ Ask for secure alternatives to risky code patterns
 * ✅ Request explanations of why code is vulnerable
 * ✅ Learn about OWASP Top 10 security risks
 * ✅ Always validate and sanitize user input
 *
 * COPILOT CHAT PROMPTS FOR SECURITY:
 * - "Perform a security check on this code"
 * - "What are the security vulnerabilities in this function?"
 * - "How can I fix this SQL injection vulnerability?"
 * - "Show me a secure way to handle user file uploads"
 * - "What OWASP vulnerabilities does this code have?"
 * - "Review this code for security best practices"
 *
 * COMMON SECURITY VULNERABILITIES:
 * - Hardcoded secrets (API keys, passwords, tokens)
 * - SQL Injection (unsanitized database queries)
 * - Path Traversal (unvalidated file paths)
 * - Cross-Site Scripting (XSS)
 * - Insecure Deserialization
 * - Missing authentication/authorization checks
 *
 * SECURITY BEST PRACTICES:
 * - Store secrets in environment variables or secret managers
 * - Use parameterized queries or ORMs for database access
 * - Validate and sanitize all user input
 * - Implement principle of least privilege
 * - Keep dependencies updated and scan for CVEs
 * - Use security linters and SAST tools
 *
 * NEXT: Move on to 10-code-translation/ to learn
 *       how to convert code between languages!
    """
